<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TraceML Architecture Diagram</title>
  <style>
    :root{
      --bg:#a9b4c2;
      --panel:#ffffff;
      --ink:#1f2430;
      --muted:#5b6474;
      --line:#2a2f3a;

      --accent1:#5eead4; /* teal */
      --accent2:#a78bfa; /* purple */
      --accent3:#fbbf24; /* amber */
      --accent4:#60a5fa; /* blue */
      --accent5:#fb7185; /* rose */

      --shadow: 0 18px 45px rgba(0,0,0,.18);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--ink);
      display:flex;
      justify-content:center;
      padding:32px 18px;
    }

    .canvas{
      width:min(980px, 96vw);
      position:relative;
      padding:26px 26px 30px;
      border-radius:18px;
      box-shadow: var(--shadow);
      border:1px solid rgba(0,0,0,.08);
      background:
        radial-gradient(1200px 500px at 30% -10%, rgba(94,234,212,.20), transparent 55%),
        radial-gradient(900px 500px at 110% 0%, rgba(167,139,250,.20), transparent 55%),
        radial-gradient(900px 500px at 60% 120%, rgba(96,165,250,.14), transparent 55%),
        #ffffff;
      overflow:hidden;
    }

    .heading{
      text-align:center;
      font: 700 15px/1.2 var(--mono);
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(31,36,48,.78);
      margin:4px 0 18px;
    }

    .box{
      border:2px solid var(--line);
      border-radius:12px;
      padding:14px 14px 12px;
      background:#fff;
      position:relative;
    }
    .box.soft{
      border-style:dashed;
      border-color:rgba(42,47,58,.65);
      background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,0));
    }
    .box .kicker{
      font: 800 12px/1 var(--mono);
      letter-spacing:.10em;
      text-transform:uppercase;
      color:rgba(31,36,48,.82);
      margin-bottom:6px;
    }
    .box .sub{
      font: 500 12.5px/1.35 var(--mono);
      color:rgba(31,36,48,.72);
    }

    .pillrow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .pill{
      font: 700 11px/1 var(--mono);
      letter-spacing:.06em;
      text-transform:uppercase;
      padding:6px 10px;
      border-radius:999px;
      border:1.5px solid rgba(42,47,58,.45);
      background:#fff;
      color:rgba(31,36,48,.78);
      display:inline-flex;
      align-items:center;
      gap:7px;
      white-space:nowrap;
    }
    .pill .dotmini{
      width:8px;height:8px;border-radius:99px;display:inline-block;
      background:var(--accent4);
    }
    .pill.teal .dotmini{background:var(--accent1)}
    .pill.purple .dotmini{background:var(--accent2)}
    .pill.amber .dotmini{background:var(--accent3)}
    .pill.rose .dotmini{background:var(--accent5)}

    .stack{
      display:flex;
      flex-direction:column;
      gap:16px;
      align-items:stretch;
    }
    .center{display:flex; justify-content:center}
    .w80{width:min(780px, 100%)}
    .w70{width:min(720px, 100%)}

    .rankWrap{ position:relative; }
    .rankGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:14px;
      align-items:stretch;
      position:relative;
    }
    @media (max-width: 860px){
      .rankGrid{grid-template-columns:1fr}
      .betweenArrow{display:none;}
    }

    .rank{
      padding:12px;
      border-radius:14px;
      border:2px solid rgba(42,47,58,.9);
      background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,0));
      position:relative;
    }
    .rank .rankTitle{
      font: 900 12px/1 var(--mono);
      letter-spacing:.10em;
      text-transform:uppercase;
      color:rgba(31,36,48,.85);
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .badge{
      font:800 10px/1 var(--mono);
      letter-spacing:.08em;
      padding:5px 9px;
      border-radius:999px;
      border:1.5px solid rgba(42,47,58,.35);
      color:rgba(31,36,48,.75);
      background:#fff;
    }

    .mini{
      border:1.8px solid rgba(42,47,58,.85);
      border-radius:12px;
      padding:10px 10px 9px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:158px;
    }
    .mini.tall{ min-height:192px; }
    .mini .miniHead{
      font:900 11.5px/1 var(--mono);
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(31,36,48,.82);
    }
    .mini .miniText{
      font: 500 12px/1.35 var(--mono);
      color:rgba(31,36,48,.72);
    }
    .mini .divider{
      height:1px;
      background:rgba(42,47,58,.18);
      margin:2px 0;
    }

    .arrowDown{
      display:flex;
      justify-content:center;
      align-items:center;
      height:18px;
    }
    .arrowDown::before{
      content:"";
      width:2px;
      height:12px;
      background:var(--line);
      display:block;
    }
    .arrowDown::after{
      content:"";
      width:0;height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-top:8px solid var(--line);
      display:block;
      margin-top:10px;
      transform:translateX(-6px);
    }

    .transport{
      display:flex;
      justify-content:center;
      margin-top:14px;
    }
    .note{
      font: 600 12px/1.45 var(--mono);
      color:rgba(31,36,48,.65);
      margin-top:14px;
      text-align:center;
    }
    .corner{
      position:absolute;
      inset:auto 12px 12px auto;
      width:10px;height:10px;
      border-right:2px solid rgba(42,47,58,.35);
      border-bottom:2px solid rgba(42,47,58,.35);
      border-radius:0 0 6px 0;
      opacity:.7;
    }

    .betweenArrow{
      position:absolute;
      left:50%;
      top:42%;
      transform:translate(-50%,-50%);
      width:140px;
      height:62px;
      pointer-events:none;
      opacity:.95;
    }
    .betweenArrow .label{
      position:absolute;
      left:50%;
      top:-2px;
      transform:translateX(-50%);
      font:800 10px/1 var(--mono);
      letter-spacing:.08em;
      text-transform:uppercase;
      background:#fff;
      border:1.5px solid rgba(42,47,58,.35);
      border-radius:999px;
      padding:5px 9px;
      color:rgba(31,36,48,.72);
      box-shadow:0 8px 20px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .betweenArrow svg{ width:100%; height:100%; display:block; }

    /* tiny highlight line inside minis */
    .tagline{
      display:inline-block;
      font:800 10px/1 var(--mono);
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(31,36,48,.62);
      background:rgba(96,165,250,.10);
      border:1px solid rgba(96,165,250,.25);
      padding:5px 8px;
      border-radius:999px;
      width:fit-content;
    }
  </style>
</head>

<body>
  <div class="canvas">
    <div class="heading">TraceML runtime + multi-rank telemetry flow</div>

    <div class="stack">

      <div class="center">
        <div class="box soft w70">
          <div class="kicker">USER / CLI</div>
          <div class="sub">Runs TraceML shell (single entrypoint)</div>
          <div class="pillrow">
            <span class="pill teal"><span class="dotmini"></span>TraceML shell</span>
            <span class="pill amber"><span class="dotmini"></span>torchrun</span>
            <span class="pill purple"><span class="dotmini"></span>N ranks</span>
          </div>
          <span class="corner"></span>
        </div>
      </div>

      <div class="arrowDown"></div>

      <div class="center">
        <div class="box w80">
          <div class="kicker">TRACE ML SHELL</div>
          <div class="sub">
            Spawns <b>torchrun</b> processes. Each rank starts:
            <b>Main Training Thread</b> + <b>TraceML Runtime Thread</b>,
            then executes user code via <b>runpy</b>.
          </div>
          <div class="pillrow">
            <span class="pill rose"><span class="dotmini"></span>runpy(user_script.py)</span>
            <span class="pill teal"><span class="dotmini"></span>runtime thread</span>
            <span class="pill amber"><span class="dotmini"></span>training thread</span>
          </div>
          <span class="corner"></span>
        </div>
      </div>

      <div class="arrowDown"></div>

      <div class="rankWrap">
        <div class="rankGrid">

          <!-- Rank 0 -->
          <div class="rank">
            <div class="rankTitle">
              <span>RANK 0</span>
              <span class="badge">UI + Aggregation</span>
            </div>

            <div class="mini">
              <div class="miniHead">Main Training Thread</div>
              <div class="miniText">Runs training loop + user script</div>
              <div class="divider"></div>
              <div class="miniHead">Run Samplers (producer)</div>
              <div class="miniText">Training thread pushes samples → per-sampler queues</div>
              <div class="pillrow" style="margin-top:2px">
                <span class="pill teal"><span class="dotmini"></span>step timing</span>
                <span class="pill teal"><span class="dotmini"></span>step memory</span>
                <span class="pill teal"><span class="dotmini"></span>layer timing</span>
                <span class="pill teal"><span class="dotmini"></span>layer memory</span>
                <span class="pill teal"><span class="dotmini"></span>timer sampler</span>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="mini tall">
              <div class="miniHead">TraceML Runtime Thread</div>
              <div class="miniText">Consumes queues asynchronously (best-effort, no training-blocking sync)</div>
              <div class="divider"></div>

              <div class="miniHead">Rank-0 only samplers</div>
              <div class="miniText">
                <span class="tagline">rank-0 only</span><br/>
                SystemSampler + ProcessSampler (single-process collectors)
              </div>

              <div class="divider"></div>

              <div class="miniHead">Databases (bounded)</div>
              <div class="miniText">
                <b>Local DB</b> (bounded queue)<br/>
                <b>Remote cache DB</b> (bounded queue for other ranks)
              </div>
              <div class="pillrow" style="margin-top:6px">
                <span class="pill amber"><span class="dotmini"></span>local db</span>
                <span class="pill purple"><span class="dotmini"></span>remote cache</span>
              </div>

              <div class="divider"></div>

              <div class="miniHead">UI Renderer</div>
              <div class="miniText">Generates live UI from Local DB + Remote Cache</div>
            </div>

            <div style="height:10px"></div>

            <div class="mini">
              <div class="miniHead">TCP Server Thread (rank 0)</div>
              <div class="miniText">
                Accepts worker connections → reads framed payloads → enqueues messages.
              </div>
              <div class="divider"></div>
              <div class="miniText">
                Runtime thread polls server queue and writes into Remote Cache DB.
              </div>
              <div class="pillrow" style="margin-top:6px">
                <span class="pill purple"><span class="dotmini"></span>accept + recv</span>
                <span class="pill amber"><span class="dotmini"></span>queue → poll()</span>
              </div>
            </div>

            <span class="corner"></span>
          </div>

          <!-- Worker ranks -->
          <div class="rank">
            <div class="rankTitle">
              <span>RANK 1..N</span>
              <span class="badge">Workers</span>
            </div>

            <div class="mini">
              <div class="miniHead">Main Training Thread</div>
              <div class="miniText">Runs training loop + user script</div>
              <div class="divider"></div>
              <div class="miniHead">Run Samplers (producer)</div>
              <div class="miniText">Training thread pushes samples → per-sampler queues</div>
              <div class="pillrow" style="margin-top:2px">
                <span class="pill teal"><span class="dotmini"></span>step timing</span>
                <span class="pill teal"><span class="dotmini"></span>step memory</span>
                <span class="pill teal"><span class="dotmini"></span>layer timing</span>
                <span class="pill teal"><span class="dotmini"></span>layer memory</span>
                <span class="pill teal"><span class="dotmini"></span>timer sampler</span>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="mini tall">
              <div class="miniHead">TraceML Runtime Thread</div>
              <div class="miniText">
                Consumes sampler queues and batches telemetry events.
              </div>
              <div class="divider"></div>
              <div class="miniHead">TCP Client (best-effort)</div>
              <div class="miniText">
                Serializes frames (len + pickle) and <b>sendall()</b> to Rank 0 server.<br/>
                If Rank 0 is down → drops silently → training continues.
              </div>
              <div class="pillrow" style="margin-top:6px">
                <span class="pill amber"><span class="dotmini"></span>send → rank 0</span>
                <span class="pill purple"><span class="dotmini"></span>best effort</span>
              </div>
            </div>

            <span class="corner"></span>
          </div>

          <!-- Between arrow -->
          <div class="betweenArrow" aria-hidden="true">
            <div class="label">tcp telemetry (async)</div>
            <svg viewBox="0 0 140 62" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 40 C 40 12, 100 12, 130 40" fill="none" stroke="rgba(42,47,58,.9)" stroke-width="2.2"/>
              <path d="M126 38 L130 40 L126 42" fill="none" stroke="rgba(42,47,58,.9)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>

        </div>
      </div>

      <div class="transport">
        <div class="box soft w80">
          <div class="kicker">Backpressure + isolation (by design)</div>
          <div class="sub">
            Training threads only push into queues. Runtime threads consume + ship asynchronously.
            Rank 0 aggregates into bounded DBs and renders UI from local + remote cache.
          </div>
          <div class="pillrow">
            <span class="pill teal"><span class="dotmini"></span>per-sampler queues</span>
            <span class="pill amber"><span class="dotmini"></span>bounded stores</span>
            <span class="pill purple"><span class="dotmini"></span>tcp server + poll</span>
          </div>
          <span class="corner"></span>
        </div>
      </div>

    </div>
  </div>
</body>
</html>
